blueprint:
  name: Hausstatus mit AI und Alexa
  description: >
    Fragt einen AI-Conversation-Agenten (Gemini, OpenAI) nach Hausstatus
    und gibt die Antwort über das zuletzt angesprochene Alexa-Gerät aus.
  domain: automation
  input:
    agent_id:
      name: AI-Agent
      description: Wähle den AI-Agenten (z. B. conversation.google_ai_conversation)
      selector:
        entity:
          domain: conversation
    ai_prompt:
      name: AI Prompt
      description: Text, der an den AI-Agenten gesendet wird
      default: >
        Agiere als Home Assistant Experte. Formuliere einen kurzen Satz mit den
        folgenden Inhalten: Sind noch Fenster oder Türen geöffnet? - welche
        Lichter sind noch eingeschaltet? Ohne Schalter oder Rollladen.
      selector:
        text:
    fallback_alexa:
      name: Fallback Alexa-Gerät
      description: Wird genutzt, falls kein zuletzt genutztes Alexa-Gerät gefunden wird.
      selector:
        entity:
          domain: media_player

trigger:
  - platform: event
    event_type: dummy_trigger
    # Dieser Blueprint wird manuell oder per Szene aufgerufen

action:
  - alias: AI-Abfrage starten
    action: conversation.process
    data:
      agent_id: !input agent_id
      text: !input ai_prompt
    response_variable: ai_response

  - alias: Variablen setzen
    variables:
      letzter_alexa: "{{ state_attr('sensor.last_called', 'entity_id') | default(fallback) }}"
      fallback: !input fallback_alexa
      ausgabe_text: "{{ ai_response.response.speech.plain.speech | default('Ich konnte den Status nicht abrufen.') }}"

  - alias: Sprachausgabe über Alexa
    action: tts.cloud_say
    target:
      entity_id: "{{ letzter_alexa }}"
    data:
      message: "{{ ausgabe_text }}"
      language: "de-DE"
